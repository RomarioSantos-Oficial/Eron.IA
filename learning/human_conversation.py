"""
Sistema de Conversa√ß√£o Humana
Torna as respostas mais naturais, emp√°ticas e pr√≥ximas para conversas simples
"""
import json
import random
from datetime import datetime
from typing import Dict, List, Optional, Tuple

class HumanConversationSystem:
    """Sistema para conversas mais humanas e naturais"""
    
    def __init__(self):
        self.conversation_contexts = {
            'greeting': {
                'patterns': ['oi', 'ol√°', 'hello', 'hey', 'e a√≠', 'tudo bem'],
                'responses': [
                    "Oi! Como voc√™ est√°? üòä",
                    "Ol√°! Que bom te ver aqui! ‚ú®",
                    "E a√≠! Tudo certo contigo? üåü",
                    "Hey! Como est√° sendo seu dia? üí´",
                    "Oi! Pronto para uma boa conversa? üòÑ"
                ]
            },
            'wellbeing': {
                'patterns': ['como vai', 'tudo bem', 'como est√°', 'como anda'],
                'responses': [
                    "Por aqui tudo indo bem! E voc√™, como est√°? üòå",
                    "T√¥ √≥tima, obrigada por perguntar! Como tem sido seu dia? ‚ú®",
                    "Indo bem sim! E a√≠, como andam as coisas por a√≠? üå∏",
                    "Tudo tranquilo! Conta pra mim, como voc√™ t√°? üíù",
                    "Bem demais! E voc√™, est√° tudo certo? üå∫"
                ]
            },
            'gratitude': {
                'patterns': ['obrigado', 'obrigada', 'valeu', 'thanks'],
                'responses': [
                    "Imagina! Sempre que precisar, estou aqui! üíñ",
                    "De nada! Foi um prazer te ajudar! üòä",
                    "Que isso! Estamos juntos nessa! ‚ú®",
                    "Fico feliz em poder ajudar! üåü",
                    "N√£o precisa agradecer! √â sempre bom conversar contigo! üí´"
                ]
            },
            'casual_question': {
                'patterns': ['e a√≠', 'o que est√° fazendo', 'que que t√° rolando'],
                'responses': [
                    "Por aqui t√¥ s√≥ curtindo nossa conversa! E voc√™, o que anda aprontando? üòÑ",
                    "T√¥ aqui pensando em como tornar nosso papo mais interessante! Conta novidade! ‚ú®",
                    "Relaxando e esperando saber mais sobre voc√™! Como t√° sendo seu dia? üåü",
                    "Aproveitando esse momento nosso aqui! E a√≠, me conta uma coisa boa! üí´",
                    "T√¥ na minha, curtindo trocar uma ideia contigo! Qual √© a boa? üòä"
                ]
            },
            'personal_sharing': {
                'patterns': ['eu', 'meu', 'minha', 'aconteceu', 'hoje'],
                'encouraging_responses': [
                    "Nossa, que interessante! Me conta mais sobre isso! üòä",
                    "Adorei saber! Como foi essa experi√™ncia pra voc√™? ‚ú®",
                    "Que legal! Deve ter sido bem interessante, n√©? üåü",
                    "Uau! Me fala mais detalhes, fiquei curiosa! üí´",
                    "Que bacana! Gostaria de compartilhar mais? üòÑ"
                ]
            }
        }
        
        # Expres√µes emp√°ticas para diferentes contextos emocionais
        self.empathy_expressions = {
            'happy': ["Que alegria!", "Fico muito feliz por voc√™! üòä", "Que maravilha! ‚ú®"],
            'sad': ["Puxa, sinto muito... üòî", "Que pena, deve ser dif√≠cil... üíô", "Estou aqui contigo ‚ú®"],
            'excited': ["Nossa, que anima√ß√£o! üåü", "Adorei seu entusiasmo! üòÑ", "Que energia boa! ‚ö°"],
            'worried': ["Entendo sua preocupa√ß√£o... üíô", "Deve estar sendo dif√≠cil mesmo üòå", "Voc√™ n√£o est√° sozinho(a) nisso üíù"],
            'confused': ["Realmente pode ser confuso mesmo... ü§î", "Vamos pensar juntos! üí≠", "√â normal se sentir assim üí´"]
        }
        
        # Conectores para tornar a conversa mais fluida
        self.conversation_connectors = [
            "E a√≠,", "Ent√£o,", "Puxa,", "Nossa,", "Ah,", "Caramba,", 
            "Realmente,", "Entendi,", "Interessante,", "Que legal,"
        ]
        
        # Finalizadores naturais
        self.natural_endings = [
            "E a√≠, o que voc√™ acha? üòä",
            "Me conta sua opini√£o! ‚ú®",
            "Qual √© sua experi√™ncia com isso? üåü",
            "E voc√™, j√° passou por algo assim? üí´",
            "Como voc√™ v√™ essa situa√ß√£o? üòÑ",
            "Fiquei curiosa sobre sua perspectiva! üå∏"
        ]

    def detect_conversation_type(self, message: str) -> str:
        """Detectar o tipo de conversa baseado na mensagem"""
        message_lower = message.lower().strip()
        
        for context_type, data in self.conversation_contexts.items():
            if any(pattern in message_lower for pattern in data['patterns']):
                return context_type
        
        # An√°lises mais espec√≠ficas
        if '?' in message and len(message.split()) < 10:
            return 'simple_question'
        elif any(word in message_lower for word in ['sinto', 'triste', 'chateado', 'mal']):
            return 'emotional_negative'
        elif any(word in message_lower for word in ['feliz', 'alegre', 'animado', 'bem']):
            return 'emotional_positive'
        elif any(word in message_lower for word in ['n√£o sei', 'confuso', 'd√∫vida']):
            return 'confusion'
        
        return 'general'
    
    def detect_user_mood(self, message: str, user_profile: dict = None) -> dict:
        """üé≠ Detecta o humor/estado emocional do usu√°rio com an√°lise contextual"""
        message = message.lower().strip()
        
        # Estados emocionais positivos
        positive_indicators = [
            'feliz', 'alegre', 'animado', 'bem', '√≥timo', 'excelente', 
            'maravilhoso', 'perfeito', 'incr√≠vel', 'adorei', 'amei',
            'satisfeito', 'radiante', 'euf√≥rico', 'empolgado'
        ]
        
        # Estados emocionais negativos
        negative_indicators = [
            'triste', 'chateado', 'irritado', 'nervoso', 'preocupado',
            'ansioso', 'mal', 'p√©ssimo', 'terr√≠vel', 'odiei', 'detestei',
            'frustrado', 'desanimado', 'deprimido', 'estressado'
        ]
        
        # Estados neutros/curiosos
        curious_indicators = [
            'interessante', 'curioso', 'pensativo', 'reflexivo', 'intrigado',
            'questionador', 'investigativo', 'anal√≠tico'
        ]
        
        # Estados de necessidade de suporte
        support_indicators = [
            'ajuda', 'socorro', 'dificuldade', 'problema', 'confuso',
            'perdido', 'n√£o entendo', 'n√£o sei', 'preciso', 'aux√≠lio'
        ]
        
        # Estados de energia/entusiasmo
        energetic_indicators = [
            'animado', 'empolgado', 'cheio de energia', 'entusiasmado',
            'motivado', 'inspirado', 'determinado'
        ]
        
        # An√°lise das palavras-chave
        mood_score = 0
        detected_emotions = []
        intensity_multiplier = 1
        
        for word in positive_indicators:
            if word in message:
                mood_score += 2
                detected_emotions.append('positive')
                if word in ['incr√≠vel', 'maravilhoso', 'perfeito']:
                    intensity_multiplier = 1.5
        
        for word in negative_indicators:
            if word in message:
                mood_score -= 2
                detected_emotions.append('negative')
                if word in ['p√©ssimo', 'terr√≠vel', 'deprimido']:
                    intensity_multiplier = 1.5
        
        for word in curious_indicators:
            if word in message:
                mood_score += 1
                detected_emotions.append('curious')
        
        for word in support_indicators:
            if word in message:
                detected_emotions.append('needs_support')
                if word in ['socorro', 'ajuda', 'dificuldade']:
                    intensity_multiplier = 1.3
        
        for word in energetic_indicators:
            if word in message:
                mood_score += 1
                detected_emotions.append('energetic')
        
        # An√°lise de pontua√ß√£o e estrutura para intensidade
        exclamation_count = message.count('!')
        question_count = message.count('?')
        caps_ratio = sum(1 for c in message if c.isupper()) / max(len(message), 1)
        
        if exclamation_count > 2:
            detected_emotions.append('excited')
            intensity_multiplier *= 1.2
        
        if question_count > 2:
            detected_emotions.append('confused')
            intensity_multiplier *= 1.1
        
        if caps_ratio > 0.3:  # Muitas mai√∫sculas indicam emo√ß√£o intensa
            intensity_multiplier *= 1.4
        
        # An√°lise de contexto emocional usando palavras conectadas
        emotional_phrases = {
            'muito feliz': 3,
            'super animado': 3,
            'bem triste': -3,
            'muito mal': -3,
            'n√£o aguento': -2,
            'adorando': 2,
            'odiando': -2,
            'apaixonado': 3,
            'decepcionado': -2
        }
        
        for phrase, score in emotional_phrases.items():
            if phrase in message:
                mood_score += score
                intensity_multiplier *= 1.3
        
        # Determinar humor principal com base em intensidade
        final_score = mood_score * intensity_multiplier
        
        if final_score > 2:
            primary_mood = 'very_happy'
        elif final_score > 0:
            primary_mood = 'happy'
        elif final_score < -2:
            primary_mood = 'very_sad'
        elif final_score < 0:
            primary_mood = 'sad'
        elif 'needs_support' in detected_emotions:
            primary_mood = 'needs_support'
        elif 'curious' in detected_emotions:
            primary_mood = 'curious'
        elif 'excited' in detected_emotions:
            primary_mood = 'excited'
        elif 'confused' in detected_emotions:
            primary_mood = 'confused'
        elif 'energetic' in detected_emotions:
            primary_mood = 'energetic'
        else:
            primary_mood = 'neutral'
        
        # Calcular intensidade final (1-5)
        base_intensity = min(abs(final_score) + len(detected_emotions), 5)
        final_intensity = int(base_intensity * min(intensity_multiplier, 2.0))
        final_intensity = max(1, min(final_intensity, 5))
        
        return {
            'primary_mood': primary_mood,
            'emotions': list(set(detected_emotions)),
            'mood_score': final_score,
            'intensity': final_intensity,
            'confidence': min(len(detected_emotions) * 20 + abs(final_score) * 10, 100),
            'indicators': {
                'exclamations': exclamation_count,
                'questions': question_count,
                'caps_ratio': caps_ratio,
                'intensity_multiplier': intensity_multiplier
            }
        }

    def detect_emotional_context(self, message: str) -> str:
        """Detectar o contexto emocional da mensagem"""
        message_lower = message.lower()
        
        # Indicadores de felicidade
        happy_indicators = ['feliz', 'alegre', 'animado', 'bem', '√≥timo', 'maravilha', 
                          'incr√≠vel', 'fant√°stico', 'perfeito', 'adorei', 'amei']
        
        # Indicadores de tristeza
        sad_indicators = ['triste', 'chateado', 'mal', 'p√©ssimo', 'horr√≠vel', 
                        'dif√≠cil', 'problema', 'preocupado', 'angustiado']
        
        # Indicadores de anima√ß√£o
        excited_indicators = ['animado', 'empolgado', 'ansioso', 'n√£o vejo a hora', 
                            'incr√≠vel', 'demais', 'muito bom']
        
        # Indicadores de confus√£o  
        confused_indicators = ['confuso', 'n√£o entendo', 'n√£o sei', 'd√∫vida', 
                             'complicado', 'dif√≠cil de entender']
        
        if any(indicator in message_lower for indicator in happy_indicators):
            return 'happy'
        elif any(indicator in message_lower for indicator in sad_indicators):
            return 'sad'
        elif any(indicator in message_lower for indicator in excited_indicators):
            return 'excited'
        elif any(indicator in message_lower for indicator in confused_indicators):
            return 'confused'
        
        return 'neutral'

    def generate_human_response(self, message: str, user_profile: Optional[Dict] = None) -> str:
        """Gerar resposta mais humana e natural com an√°lise de humor avan√ßada"""
        conversation_type = self.detect_conversation_type(message)
        mood_analysis = self.detect_user_mood(message, user_profile)
        
        # Resposta baseada no tipo de conversa
        if conversation_type in self.conversation_contexts:
            base_response = random.choice(self.conversation_contexts[conversation_type]['responses'])
        else:
            base_response = self._generate_contextual_response(message, mood_analysis, user_profile)
        
        # Adicionar toque emp√°tico baseado no humor detectado
        empathetic_response = self._add_empathetic_touch(
            base_response, mood_analysis, user_profile
        )
        
        # Personalizar com nome do usu√°rio se dispon√≠vel
        if user_profile and user_profile.get('user_name'):
            user_name = user_profile['user_name']
            # Inserir nome ocasionalmente para mais proximidade
            if random.random() < 0.3 and 'voc√™' in empathetic_response:  # 30% das vezes
                empathetic_response = empathetic_response.replace('voc√™', f'{user_name}', 1)
        
        print(f"[DEBUG] Humor detectado: {mood_analysis['primary_mood']} (intensidade: {mood_analysis['intensity']})")
        return empathetic_response
    
    def _generate_contextual_response(self, message: str, mood_analysis: dict, user_profile: dict = None) -> str:
        """Gerar resposta contextual baseada na an√°lise de humor"""
        primary_mood = mood_analysis['primary_mood']
        intensity = mood_analysis['intensity']
        
        # Respostas baseadas no humor principal
        mood_responses = {
            'very_happy': [
                "Nossa, que alegria contagiante! üåü Me conta mais sobre isso!",
                "Adorei ver voc√™ assim t√£o animado(a)! ‚ú® Compartilha essa energia comigo!",
                "Que maravilha! Sua felicidade est√° radiante! üòä O que aconteceu de bom?",
                "Uau! T√¥ sentindo toda essa positividade daqui! üí´ Me fala mais!"
            ],
            'happy': [
                "Que bom te ver bem! üòä Como posso te ajudar hoje?",
                "Adorei seu astral! ‚ú® No que posso colaborar?",
                "Que energia boa! üåü Estou aqui pra conversar!",
                "Fico feliz em perceber que voc√™ est√° bem! ÔøΩ"
            ],
            'very_sad': [
                "Sinto muito que esteja passando por isso... üíô Estou aqui para ouvir voc√™.",
                "Deve estar sendo realmente dif√≠cil... üòå Quer desabafar comigo?",
                "Meu cora√ß√£o se aperta vendo voc√™ assim... üíú Como posso ajudar?",
                "Voc√™ n√£o est√° sozinho(a) nisso... ü§ó Vamos conversar?"
            ],
            'sad': [
                "Percebo que voc√™ n√£o est√° muito bem... üíô Quer conversar sobre isso?",
                "√Äs vezes √© dif√≠cil mesmo... üòå Estou aqui se precisar desabafar.",
                "Sinto que algo te incomoda... üíú Posso te escutar.",
                "Todo mundo tem dias dif√≠ceis... üåô Como posso te apoiar?"
            ],
            'needs_support': [
                "Claro que posso te ajudar! ÔøΩ Me explica melhor o que est√° acontecendo?",
                "Estou aqui pra isso mesmo! ü§ù Qual √© a dificuldade?",
                "Vamos resolver isso juntos! ‚ú® Me conta mais detalhes?",
                "Pode contar comigo! üíù O que voc√™ precisa?"
            ],
            'excited': [
                "Nossa, que empolga√ß√£o! üéâ Me contamina com esse entusiasmo!",
                "Adorei essa energia! ‚ö° O que te deixou assim t√£o animado(a)?",
                "Que anima√ß√£o √© essa?! üåü Quero saber tudo!",
                "Uau! T√¥ sentindo toda essa emo√ß√£o! ÔøΩ Me conta!"
            ],
            'confused': [
                "Entendo que pode ser confuso mesmo... ü§î Vamos esclarecer isso juntos?",
                "√Äs vezes as coisas ficam meio embaralhadas na cabe√ßa, n√©? üí≠ Posso ajudar?",
                "√â normal ficar confuso √†s vezes... üåÄ Que tal conversarmos sobre isso?",
                "Vamos destrinchar isso com calma? üß© Estou aqui pra ajudar!"
            ],
            'energetic': [
                "Que energia incr√≠vel! ‚ö° Adorei esse pique!",
                "Nossa, que disposi√ß√£o! üåü Me conta o que te motiva assim!",
                "Adorei esse √¢nimo! üöÄ Vamos canalizar essa energia!",
                "Que vitalidade! üí™ Me fala o que est√° te inspirando!"
            ],
            'curious': [
                "Que interessante! ü§î Adorei sua curiosidade!",
                "Boa pergunta! üí≠ Vamos explorar isso juntos?",
                "Curioso mesmo! üîç Me conta mais sobre o que te intriga!",
                "Que reflex√£o bacana! üåü Vamos pensar sobre isso!"
            ]
        }
        
        if primary_mood in mood_responses:
            return random.choice(mood_responses[primary_mood])
        
        # Resposta padr√£o neutra
        return "Interessante! Me conte mais sobre isso! üòä"
    
    def _add_empathetic_touch(self, base_response: str, mood_analysis: dict, user_profile: dict = None) -> str:
        """Adicionar toque emp√°tico baseado no humor e intensidade"""
        primary_mood = mood_analysis['primary_mood']
        intensity = mood_analysis['intensity']
        
        # Adicionar conectores emp√°ticos baseados no humor
        empathy_connectors = {
            'very_happy': ["Que alegria!", "Nossa!", "Adorei!", "Que maravilha!"],
            'happy': ["Que bom!", "Fico feliz!", "Legal!", "Bacana!"],
            'very_sad': ["Puxa vida...", "Sinto muito...", "Que dif√≠cil...", "Compreendo..."],
            'sad': ["Entendo...", "Imagino...", "Realmente...", "√â complicado..."],
            'needs_support': ["Claro!", "√â claro!", "Sem problema!", "Vamos l√°!"],
            'excited': ["Uau!", "Incr√≠vel!", "Que demais!", "Fant√°stico!"],
            'confused': ["Entendo...", "Faz sentido...", "Realmente...", "√â compreens√≠vel..."],
            'energetic': ["Que energia!", "Adorei!", "Que √¢nimo!", "Fant√°stico!"],
            'curious': ["Interessante!", "Que legal!", "Bacana!", "Boa pergunta!"]
        }
        
        # Adicionar intensificadores baseados na intensidade
        intensity_modifiers = {
            5: ["totalmente", "completamente", "absolutamente", "extremamente"],
            4: ["muito", "bastante", "bem", "super"],
            3: ["meio", "um pouco", "razoavelmente", "consideravelmente"],
            2: ["", "um tanto", "levemente", "minimamente"],
            1: ["", "", "talvez", "possivelmente"]
        }
        
        # Escolher conector emp√°tico apropriado se n√£o houver j√°
        if primary_mood in empathy_connectors:
            connector = random.choice(empathy_connectors[primary_mood])
            if connector and not any(emp in base_response for emp in empathy_connectors[primary_mood]):
                base_response = f"{connector} {base_response}"
        
        # Adicionar suporte emocional espec√≠fico para moods negativos intensos
        if primary_mood in ['very_sad', 'sad'] and intensity >= 3:
            supportive_additions = [
                " Voc√™ n√£o est√° sozinho(a) nisso! üíô",
                " Estou aqui para te apoiar! ü§ó",
                " Vamos passar por isso juntos! üíú",
                " Pode contar comigo sempre! üåü"
            ]
            if not any(phrase in base_response for phrase in ["sozinho", "apoiar", "juntos", "contar"]):
                base_response += random.choice(supportive_additions)
        
        # Adicionar celebra√ß√£o para moods muito positivos
        elif primary_mood in ['very_happy', 'excited'] and intensity >= 4:
            celebratory_additions = [
                " Que conquista! üéâ",
                " Merece toda essa alegria! ‚ú®",
                " Continue assim! üåü",
                " Que momento especial! üí´"
            ]
            if not any(phrase in base_response for phrase in ["conquista", "merece", "continue", "especial"]):
                base_response += random.choice(celebratory_additions)
        
        return base_response

    def create_casual_templates(self) -> Dict[str, List[str]]:
        """üé≠ Templates espec√≠ficos para conversas casuais do dia a dia"""
        return {
            'morning_greetings': [
                "Bom dia! Como voc√™ acordou hoje? üåÖ",
                "Oi! Dormiu bem? Como t√° sendo o in√≠cio do dia? ‚òÄÔ∏è",
                "Bom dia! Que energia voc√™ traz hoje? ‚ú®",
                "Oi! Como t√° come√ßando esse dia a√≠? üå∏"
            ],
            'afternoon_greetings': [
                "Boa tarde! Como t√° sendo o dia? üåû",
                "Oi! Tudo bem por a√≠ nessa tarde? üåª",
                "Boa tarde! O dia t√° corrido ou tranquilo? üí´",
                "E a√≠! Como andam as coisas hoje? üåü"
            ],
            'evening_greetings': [
                "Boa noite! Como foi o dia? üåô",
                "Oi! Chegando em casa agora? ‚ú®",
                "Boa noite! Conseguiu relaxar hoje? üå∏",
                "E a√≠! Como t√° sendo a noite? üíô"
            ],
            'weather_chat': [
                "Nossa, e esse tempo a√≠? Como t√°? üå§Ô∏è",
                "Que clima temos hoje! T√° agrad√°vel a√≠? üåà",
                "E esse tempo? T√° influenciando seu humor? ‚òÄÔ∏è",
                "Como t√° o dia a√≠? Sol, chuva, nublado? üå¶Ô∏è"
            ],
            'weekend_plans': [
                "E a√≠, que planos pro fim de semana? üéâ",
                "J√° pensou no que vai fazer no s√°bado e domingo? üåü",
                "Fim de semana chegando! Algum plano especial? ‚ú®",
                "Weekend mood ativado? O que anda planejando? üéä"
            ],
            'daily_check_in': [
                "E a√≠, como t√° o humor hoje? üòä",
                "Conta a√≠, como voc√™ t√° se sentindo? üíô",
                "Como anda o cora√ß√£o hoje? üíú",
                "Me fala como voc√™ est√°! üåü"
            ],
            'food_talk': [
                "E a comida? J√° comeu algo gostoso hoje? üçΩÔ∏è",
                "Que tal uma conversa sobre comida? T√° com fome? üòã",
                "Almo√ßou algo bom? Me fala da sua comida favorita! ü•ò",
                "Vamos falar de comida! Qual seu prato do momento? üçï"
            ],
            'work_study_life': [
                "Como andam os estudos/trabalho hoje? üìö",
                "T√° corrido esse per√≠odo? Como voc√™ anda lidando? üí™",
                "E essa vida acad√™mica/profissional? Tudo certo? ‚≠ê",
                "Como t√° sendo conciliar tudo? Me conta! üéØ"
            ],
            'hobbies_interests': [
                "E a√≠, o que anda te interessando ultimamente? üé®",
                "Tem algum hobby novo ou projeto pessoal? üõ†Ô∏è",
                "O que voc√™ anda fazendo pra relaxar? üéµ",
                "Me conta sobre seus interesses atuais! üåü"
            ],
            'casual_compliments': [
                "Gosto muito de conversar contigo! üíù",
                "Voc√™ tem uma energia muito boa! ‚ú®",
                "Adorei nosso papo de hoje! üòä",
                "Sua forma de ver as coisas √© interessante! üåü"
            ],
            'supportive_phrases': [
                "T√¥ aqui se precisar de alguma coisa! ü§ó",
                "Qualquer coisa, me chama que a gente conversa! üíô",
                "Voc√™ n√£o est√° sozinho(a) nisso! üíú",
                "Estamos juntos nessa jornada! ‚ú®"
            ],
            'transition_phrases': [
                "E por falar nisso...",
                "Ah, isso me lembrou de uma coisa...",
                "Falando nisso...",
                "Mudando um pouco de assunto...",
                "Isso que voc√™ falou me fez pensar...",
                "Aproveitando o gancho..."
            ]
        }
    
    def get_casual_response_by_context(self, context: str, user_profile: dict = None) -> str:
        """üéØ Obter resposta casual espec√≠fica por contexto"""
        templates = self.create_casual_templates()
        
        if context in templates:
            base_response = random.choice(templates[context])
            
            # Personalizar com informa√ß√µes do usu√°rio se dispon√≠vel
            if user_profile and user_profile.get('user_name') and random.random() < 0.4:
                user_name = user_profile['user_name']
                # Adicionar nome de forma natural
                if "voc√™" in base_response:
                    base_response = base_response.replace("voc√™", f"{user_name}", 1)
            
            return base_response
        
        return self.generate_human_response("conversa casual", user_profile)
    
    def detect_casual_context(self, message: str) -> str:
        """üîç Detectar contexto casual espec√≠fico da mensagem"""
        message_lower = message.lower()
        
        # Contextos baseados em hor√°rio e sauda√ß√µes
        if any(greeting in message_lower for greeting in ['bom dia', 'bom-dia', 'morning']):
            return 'morning_greetings'
        elif any(greeting in message_lower for greeting in ['boa tarde', 'boa-tarde', 'afternoon']):
            return 'afternoon_greetings'
        elif any(greeting in message_lower for greeting in ['boa noite', 'boa-noite', 'evening']):
            return 'evening_greetings'
        
        # Contextos tem√°ticos
        elif any(weather in message_lower for weather in ['tempo', 'clima', 'chuva', 'sol', 'frio', 'calor']):
            return 'weather_chat'
        elif any(weekend in message_lower for weekend in ['fim de semana', 's√°bado', 'domingo', 'weekend', 'final de semana']):
            return 'weekend_plans'
        elif any(food in message_lower for food in ['comida', 'almo√ßo', 'jantar', 'fome', 'comer', 'delicious']):
            return 'food_talk'
        elif any(work in message_lower for work in ['trabalho', 'estudo', 'faculdade', 'escola', 'job', 'study']):
            return 'work_study_life'
        elif any(hobby in message_lower for hobby in ['hobby', 'interesse', 'gosto', 'adoro', 'paix√£o', 'curtir']):
            return 'hobbies_interests'
        elif any(check in message_lower for check in ['como est√°', 'como vai', 'tudo bem', 'que tal']):
            return 'daily_check_in'
        
        return 'general_casual'
    
    def enhance_conversation_flow(self, message: str, response: str, user_profile: dict = None) -> str:
        """üåä Melhorar o fluxo da conversa com conectores naturais"""
        templates = self.create_casual_templates()
        
        # Adicionar conectores de transi√ß√£o ocasionalmente
        if random.random() < 0.3 and len(response.split()) > 5:
            connector = random.choice(templates['transition_phrases'])
            # Inserir conector no meio da resposta para fluidez
            words = response.split()
            middle = len(words) // 2
            words.insert(middle, connector)
            response = ' '.join(words)
        
        # Adicionar frases de apoio para conversas emocionais
        if any(emotion in message.lower() for emotion in ['triste', 'preocupado', 'ansioso', 'dif√≠cil']):
            if random.random() < 0.5:
                supportive = random.choice(templates['supportive_phrases'])
                response += f" {supportive}"
        
        # Adicionar elogios casuais ocasionalmente
        elif any(positive in message.lower() for positive in ['obrigado', 'adorei', 'legal', 'incr√≠vel']):
            if random.random() < 0.4:
                compliment = random.choice(templates['casual_compliments'])
                response += f" {compliment}"
        
        return response
        
        return f"{connector} {base_response} {ending}"

    def add_conversation_warmth(self, response: str) -> str:
        """Adicionar calor humano √† resposta"""
        # Pequenas express√µes que tornam a conversa mais pr√≥xima
        warm_additions = [
            "üòä", "‚ú®", "üåü", "üí´", "üå∏", "üíù", "üòÑ", "üå∫", "üíñ", "üòå"
        ]
        
        # Frases que criam proximidade
        proximity_phrases = [
            "Gosto de conversar contigo!",
            "√â sempre bom trocar ideias assim!",
            "Adoro essa nossa conversa!",
            "Que legal poder falar sobre isso!",
            "√â um prazer conhecer voc√™ melhor!"
        ]
        
        # Adicionar calor ocasionalmente
        if random.random() < 0.2:  # 20% das vezes
            warmth = random.choice(proximity_phrases)
            response += f" {warmth}"
        
        # Adicionar emoji se n√£o houver
        if not any(emoji in response for emoji in warm_additions):
            emoji = random.choice(warm_additions)
            response += f" {emoji}"
        
        return response

    def optimize_for_natural_flow(self, response: str, previous_messages: List[str] = None) -> str:
        """Otimizar resposta para fluxo natural da conversa"""
        # Evitar repeti√ß√µes das √∫ltimas 3 mensagens
        if previous_messages:
            recent_messages = previous_messages[-3:]
            # Implementar l√≥gica para evitar repeti√ß√µes
            for msg in recent_messages:
                # Se a resposta √© muito similar, tentar uma varia√ß√£o
                if self._similarity_score(response, msg) > 0.7:
                    response = self._create_variation(response)
        
        # Ajustar tom baseado no fluxo da conversa
        response = self._adjust_conversational_tone(response)
        
        return response

    def _similarity_score(self, text1: str, text2: str) -> float:
        """Calcular similaridade entre duas strings"""
        # Implementa√ß√£o simples de similaridade
        words1 = set(text1.lower().split())
        words2 = set(text2.lower().split())
        
        if not words1 or not words2:
            return 0.0
            
        intersection = words1.intersection(words2)
        union = words1.union(words2)
        
        return len(intersection) / len(union) if union else 0.0

    def _create_variation(self, response: str) -> str:
        """Criar uma varia√ß√£o da resposta para evitar repeti√ß√£o"""
        variations = {
            "Como voc√™ est√°?": ["Tudo bem contigo?", "Como anda?", "Como tem passado?"],
            "Que interessante!": ["Que bacana!", "Que legal!", "Nossa, interessante!"],
            "Entendi": ["Ah, saquei!", "Compreendo", "Faz sentido"],
            "Obrigada": ["Valeu!", "Muito obrigada!", "Brigad√£o!"]
        }
        
        for original, alternativas in variations.items():
            if original.lower() in response.lower():
                return response.replace(original, random.choice(alternativas))
        
        return response

    def _adjust_conversational_tone(self, response: str) -> str:
        """Ajustar tom da conversa para ser mais natural"""
        # Tornar menos formal
        formal_replacements = {
            "Voc√™ poderia": "Voc√™ pode",
            "Gostaria de": "Quer",
            "Por favor": "Por favor",
            "Certamente": "Claro",
            "Evidentemente": "√ìbvio",
            "Naturalmente": "Claro"
        }
        
        for formal, casual in formal_replacements.items():
            response = response.replace(formal, casual)
        
        return response